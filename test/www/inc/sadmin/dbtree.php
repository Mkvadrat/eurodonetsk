<?php// подключаем файл с настройками подключения к БД   require_once ('dbconnect.inc'); /* ------------------------ NEW OBJECT ------------------------ */require_once('dbtree.class.php');// Create new object	session_start();	session_register("lng");    //if ($_GET['lang']=='en')    if ($_GET['lang'])     $_SESSION['lng']=$_GET['lang'];if ($_SESSION['lng']=='en')    $tbl_lng = 'sections_en';else if ($_SESSION['lng']=='ru')    $tbl_lng = 'sections_ru';else     $tbl_lng = 'sections_ru';$dbtree = new dbtree($tbl_lng, 'section', $db);//=====MAP OF SITE:=====$navigator = ' Вы находитесь здесь: ';if (!empty($_GET['section_id']) && 'map' == $_GET['mode'] ) {    $dbtree->Parents((int)$_GET['section_id'], array('section_id', 'section_name'));    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }	    while ($item = $dbtree->NextRow()) {        if (@$_GET['section_id'] <> $item['section_id']) {            $navigator .= '<a href="dbtree_visual.php?mode=' . $_GET['mode'] . '&section_id=' . $item['section_id'] . '">' . $item['section_name'] . '</a> > ';        } else {            $navigator .= '<strong>' . $item['section_name'] . '</strong>';        }    }}/* ------------------------ MAP ------------------------ */if (!empty($_GET['mode']) && 'map' == $_GET['mode']) {    // Prepare data to view all tree    $dbtree->Full('');    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    ?>    <table border="0" cellpadding="5" width="100%" class="tab_class">        <tr>            <td>        <?php                echo $navigator . '<br><br>';       $last_lev = 0;        while ($item = $dbtree->NextRow()) {	//if (($item['section_level'] == 0) or ($item['section_level'] == 1) or ($last_lev <> $item['section_level'] ) )		{ echo '<br>';		} 	$last_lev = $item['section_level'];	            if (@$_GET['section_id'] <> $item['section_id']) {                echo str_repeat('&nbsp;', 12 * $item['section_level']) . '<a href="dbtree_visual.php?mode=map&section_id=' . $item['section_id'] . '">' . $item['section_name'] . '</a>';            }             else {                echo str_repeat('&nbsp;', 6 * $item['section_level']) . '<strong>' . $item['section_name'] . '</strong>';            }        }        ?>            </td>        </tr>    </table></br></br></br></br><?php} /*else else//=====менеджер разделов:=====*/{?><?php/* ------------------------ MOVE ------------------------ *//* ------------------------ MOVE 2 --------------------- */// Method 2: Assigns a node with all its children to another parent.if (!empty($_GET['action']) && 'move_2' == $_GET['action']) {    // Переместить раздел ($_GET['section_id']) и все подразделы в новый родительский раздел ($_POST['section2_id'])    $dbtree->MoveAll((int)$_GET['section_id'], (int)$_POST['section2_id']);    // Check errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    header('Location:sadmin.php?sub_m=1');    exit;}/* ------------------------ MOVE 1 ------------------------ */// Method 1: Swapping nodes within the same level and limits of one parent with all its children.if (!empty($_GET['action']) && 'move_1' == $_GET['action']) {    // Change node ($_GET['section_id']) position and all its childrens to    // before or after ($_POST['position']) node 2 ($_POST['section2_id'])    $dbtree->ChangePositionAll((int)$_GET['section_id'], (int)$_POST['section2_id'], $_POST['position']);    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    header('Location:sadmin.php?sub_m=1');    exit;}/* ------------------------ MOVE FORM------------------------ */// Move section formif (!empty($_GET['action']) && 'move' == $_GET['action']) {    // Prepare the restrictive data for the first method:    // Swapping nodes within the same level and limits of one parent with all its children    $current_section = $dbtree->GetNodeInfo((int)$_GET['section_id']);    $dbtree->Parents((int)$_GET['section_id'], array('section_id'), array('and' => array('section_level = ' . ($current_section[2] - 1))));    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    $item = $dbtree->NextRow();    $dbtree->Branch($item['section_id'], array('section_id', 'section_name'), array('and' => array('section_level = ' . $current_section[2])));    // Create form    ?>    <table border="1" cellpadding="5" align="center" class="tab_class">        <tr>            <td>                Перемещение раздела:            </td>        </tr>        <tr>            <td>                <form action="sadmin.php?sub_m=1&action=move_1&section_id=<?=$_GET['section_id']?>" method="POST">                <strong>1) Обменять раздел(со всеми подразделами) в пределах одного уровня ограниченного разделом-родителем.</strong><br>                Выбрать второй раздел для обмена:                <select name="section2_id">    <?php    while ($item = $dbtree->NextRow()) {        ?>                    <option value="<?=$item['section_id']?>"><?=$item['section_name']?> <?php echo $item['section_id'] == (int)$_GET['section_id'] ? '<<<' : ''?></option>        <?php    }    ?>                </select><br>                Выбрать позицию:                <select name="position">                    <option value="after">После</option>                    <option value="before">До</option>                </select><br>                <center><input type="submit" value="Применить"></center><br>                </form>                <form action="sadmin.php?sub_m=1&action=move_2&section_id=<?=$_GET['section_id']?>" method="POST">                <strong>2) Поменять раздел-родителя для раздела(вместе со всеми подразделами)</strong><br>                Выбрать новый раздел-родитель:                <select name="section2_id">    <?php    // Prepare the data for the second method:    // Assigns a node with all its children to another parent    $dbtree->Full(array('section_id', 'section_level', 'section_name'), array('or' => array('section_left <= ' . $current_section[0], 'section_right >= ' . $current_section[1])));    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    while ($item = $dbtree->NextRow()) {        ?>                    <option value="<?=$item['section_id']?>"><?=str_repeat('&nbsp;', 6 * $item['section_level'])?><?=$item['section_name']?> <?php echo $item['section_id'] == (int)$_GET['section_id'] ? '<<<' : ''?></option>        <?php    }    ?>                </select><br>                <center><input type="submit" value="Применить"></center><br>                </form>            </td>        </tr>    </table>	    <?php}/* ------------------------ DELETE ------------------------ */// Delete node ($_GET['section_id']) from the tree wihtout deleting it's children// All children apps to one levelif (!empty($_GET['action']) && 'delete' == $_GET['action']) {    $dbtree->Delete((int)$_GET['section_id']);    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    header('Location:sadmin.php?sub_m=1');    exit;}/* ------------------------ EDIT ------------------------ *//* ------------------------ EDIT OK ------------------------ */// Update node ($_GET['section_id']) infoif (!empty($_GET['action']) && 'edit_ok' == $_GET['action']) {    $sql = 'SELECT * FROM '.$tbl_lng.' WHERE section_id = ' . (int)$_GET['section_id'];    $res = $db->Execute($sql);    // Check adodb errors    if (FALSE === $res) {        echo 'internal_error';        echo '<pre>';        print_r(array(2, 'SQL query error.', __FILE__ . '::' . __CLASS__ . '::' . __FUNCTION__ . '::' . __LINE__, 'SQL QUERY: ' . $sql, 'SQL ERROR: ' . $db->ErrorMsg()));        echo '</pre>';        exit;    }    if (0 == $res->RecordCount()) {        echo 'section_not_found';        exit;    }    $sql = $db->GetUpdateSQL($res, $_POST['section']);    if (!empty($sql)) {        $res = $db->Execute($sql);        // Check adodb errors        if (FALSE === $res) {            echo 'internal_error';            echo '<pre>';            print_r(array(2, 'SQL query error.', __FILE__ . '::' . __CLASS__ . '::' . __FUNCTION__ . '::' . __LINE__, 'SQL QUERY: ' . $sql, 'SQL ERROR: ' . $db->ErrorMsg()));            echo '</pre>';            exit;        }    }    header('Location:sadmin.php?sub_m=1');    exit;}/* ------------------------ SET ACTUAL ------------------------ */if (!empty($_GET['action']) && $_GET['action'] == 'actual'){    $start_actual = 0;    $start_level = 0;    $dbtree->Branch((int)$_GET['section_id'],array('section_id','section_level','section_actual'));    while ($item = $dbtree->NextRow())     {	//echo $item['section_id'].' '.$item['section_name'].'<br>';	if ($item['section_id'] == $_GET['section_id'])	{	    $start_actual = 1;	    $start_level = $item['section_level'];	}	    	if ($start_actual)	{	   $query = "UPDATE ".$tbl_lng." SET section_actual = '".$_GET['act']."'                     WHERE section_id = '".(int)$item['section_id']."'"; 	    mysql_query($query); 	}    }}/* ------------------------ EDIT FORM ------------------------ */// Node edit formif (!empty($_GET['action']) && 'edit' == $_GET['action']) {    $sql = 'SELECT section_name FROM '.$tbl_lng.' WHERE section_id = ' . (int)$_GET['section_id'];    $res = $db->GetOne($sql);    // Check adodb errors    if (FALSE === $res) {        echo 'internal_error';        echo '<pre>';        print_r(array(2, 'SQL query error.', __FILE__ . '::' . __CLASS__ . '::' . __FUNCTION__ . '::' . __LINE__, 'SQL QUERY: ' . $sql, 'SQL ERROR: ' . $db->ErrorMsg()));        echo '</pre>';        exit;    }    ?>   <table border="1" cellpadding="5" align="center" class="tab_class">        <tr>            <td>                Редактировать название раздела            </td>        </tr>        <tr>            <td align="center">                <form action="sadmin.php?sub_m=1&action=edit_ok&section_id=<?=$_GET['section_id']?>" method="POST">                Новое название:<br>                <input type="text" name="section[section_name]" value="<?=$res?>"><br><br>                <input type="submit" name="submit" value="Утвердить">                </form>            </td>        </tr>    </table>	    <?php}/* ------------------------ ADD ------------------------ *//* ------------------------ ADD OK ------------------------ */// Add new node as children to selected node ($_GET['section_id'])if (!empty($_GET['action']) && 'add_ok' == $_GET['action']) {    // Add new node    $dbtree->Insert((int)$_GET['section_id'], '', $_POST['section']);    // Check class errors    if (!empty($dbtree->ERRORS_MES)) {        echo 'DB Tree Error!';        echo '<pre>';        print_r($dbtree->ERRORS_MES);        if (!empty($dbtree->ERRORS)) {            print_r($dbtree->ERRORS);        }        echo '</pre>';        exit;    }    header('Location:sadmin.php?sub_m=1');    exit;}/* ------------------------ ADD FORM ------------------------ */// Add new node formif (!empty($_GET['action']) && 'add' == $_GET['action']) {    ?>	    <table border="1" cellpadding="5" align="center" class="tab_class">        <tr>            <td>                Новый подраздел            </td>        </tr>        <tr>            <td align="center">                <form action="sadmin.php?sub_m=1&action=add_ok&section_id=<?=$_GET['section_id']?>" method="POST">                Название:<br>                <input type="text" name="section[section_name]" value=""><br><br>                <input type="submit" name="submit" value="Утвердить">                </form>            </td>        </tr>    </table>	    <?php}/* ------------------------ LIST ------------------------ */// Prepare data to view all tree$dbtree->Full('');// Check class errorsif (!empty($dbtree->ERRORS_MES)) {    echo 'DB Tree Error!';    echo '<pre>';    print_r($dbtree->ERRORS_MES);    if (!empty($dbtree->ERRORS)) {        print_r($dbtree->ERRORS);    }    echo '</pre>';    exit;}    ?>        <table border="1" cellpadding="5" width="100%" class="manager_branch">        <tr bgcolor="#dddddd">            <td width="100%">Название раздела</td>            <td colspan="5" style="text-align:center;">Действия</td>        </tr>    <?php    $counter = 1;    while ($item = $dbtree->NextRow()) {        if ($counter % 2) {            $bgcolor = '#dddddd';        } else {            $bgcolor = '#dddddd';        }		switch($item['section_level'])	{	    case 0: $color_link = "#000000";		break;	    case 1:		$color_link = "#960018";		break;	    case 2:		$color_link = "#365b07";		break;	    case 3:		$color_link = "#000080";		break;	    case 4:		$color_link = "#000000";		break;	    default:		$color_link = "#000000";		break;	}		if ($item['section_actual'] == 0)	    $color_link = "#aaaaaa";        $counter++;        ?>        <tr onmouseover='OverMnu(this, "#bbbbbb");' onmouseout='OutMnu(this, "");' bgcolor="<?=$bgcolor?>">            <td >                <?=str_repeat('&nbsp;', 6 * $item['section_level']) . '<strong><font color="'.$color_link.'">' . $item['section_name']?></font></strong> [<strong><?=$item['section_left']?></strong>, <strong><?=$item['section_right']?></strong>, <strong><?=$item['section_level']?></strong>]            </td>            <td >                <a href="sadmin.php?sub_m=1&action=add&section_id=<?=$item['section_id']?>">Д</a>            </td>            <td >                <a href="sadmin.php?sub_m=1&action=edit&section_id=<?=$item['section_id']?>">Р</a>            </td>            <td >                        <?php            if (0 == $item['section_level']) {                echo 'У';            }             else {                ?>                <a href="sadmin.php?sub_m=1&action=delete&section_id=<?=$item['section_id']?>">У</a>                <?php            }            ?>                        </td>            <td >                        <?php            if (0 == $item['section_level']) {                echo 'П';            } else {                ?>                <a href="sadmin.php?sub_m=1&action=move&section_id=<?=$item['section_id']?>">П</a>                <?php            }            ?>            </td>	    <td >                <a href="sadmin.php?sub_m=1&action=actual&section_id=<?=$item['section_id']?>&act=<?=!$item['section_actual']?>">А</a>            </td>        </tr>        <?php    }    ?>    </table><?php}?>